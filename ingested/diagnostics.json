[
  {
    "cell": "initDDL",
    "sql": "CREATE TABLE IF NOT EXISTS \"ingest_session\" (\n    \"ingest_session_id\" TEXT PRIMARY KEY NOT NULL,\n    \"ingest_src\" TEXT NOT NULL,\n    \"ingest_table_name\" TEXT,\n    \"elaboration\" TEXT\n);\nCREATE TABLE IF NOT EXISTS \"ingest_issue_tabular\" (\n    \"ingest_issue_tabular_id\" TEXT PRIMARY KEY NOT NULL,\n    \"session_id\" TEXT NOT NULL,\n    \"issue_type\" TEXT NOT NULL,\n    \"issue_message\" TEXT NOT NULL,\n    \"issue_row\" INTEGER,\n    \"issue_column\" TEXT,\n    \"invalid_value\" TEXT,\n    \"remediation\" TEXT,\n    \"elaboration\" TEXT,\n    FOREIGN KEY(\"session_id\") REFERENCES \"ingest_session\"(\"ingest_session_id\")\n);\n",
    "status": 0
  },
  {
    "cell": "structuralSQL",
    "sql": "INSERT INTO ingest_session (ingest_session_id, ingest_src, ingest_table_name) \n                    VALUES ('6aebd5b8-c1b6-4afb-b160-6328bd174c01', '/home/snshah/workspaces/github.com/qe-collaborative-services/1115-hub/src/synthetic-content/synthetic-fail.csv', 'synthetic_fail');\n\nCREATE TABLE synthetic_fail AS\n  SELECT *, row_number() OVER () as src_file_row_number, '6aebd5b8-c1b6-4afb-b160-6328bd174c01'\n    FROM read_csv_auto('/home/snshah/workspaces/github.com/qe-collaborative-services/1115-hub/src/synthetic-content/synthetic-fail.csv', header=true);\n\nWITH required_column_names_in_src AS (\n    SELECT column_name\n      FROM (VALUES ('PAT_MRN_ID'), ('FACILITY'), ('FIRST_NAME'), ('LAST_NAME'), ('PAT_BIRTH_DATE'), ('MEDICAID_CIN'), ('ENCOUNTER_ID'), ('SURVEY'), ('SURVEY_ID'), ('RECORDED_TIME'), ('QUESTION'), ('MEAS_VALUE'), ('QUESTION_CODE'), ('QUESTION_CODE_SYSTEM_NAME'), ('ANSWER_CODE'), ('ANSWER_CODE_SYSTEM_NAME'), ('SDOH_DOMAIN'), ('NEED_INDICATED'), ('VISIT_PART_2_FLAG'), ('VISIT_OMH_FLAG'), ('VISIT_OPWDD_FLAG')) AS required(column_name)\n     WHERE required.column_name NOT IN (\n         SELECT upper(trim(column_name))\n           FROM information_schema.columns\n          WHERE table_name = 'synthetic_fail')\n)\nINSERT INTO ingest_issue_tabular (ingest_issue_tabular_id, session_id, issue_type, issue_message, remediation)\n          SELECT uuid(),\n                 '6aebd5b8-c1b6-4afb-b160-6328bd174c01', \n                 'Missing Column',\n                 'Required column ' || column_name || ' is missing in synthetic_fail.',\n                 'Ensure synthetic_fail contains the column \"' || column_name || '\"'\n            FROM required_column_names_in_src;\n\n-- emit the errors for the given session (file) so it can be picked up\nSELECT * FROM ingest_issue_tabular WHERE session_id = '6aebd5b8-c1b6-4afb-b160-6328bd174c01';",
    "status": 0,
    "result": [
      {
        "ingest_issue_tabular_id": "c8daea83-fb7b-4236-b2d4-75329c45d9e1",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column PAT_MRN_ID is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"PAT_MRN_ID\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "5231d332-934f-41a1-bf3a-bf4e729f91b7",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column FACILITY is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"FACILITY\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "1f312a3c-27fb-432b-a263-e438e4185b71",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column FIRST_NAME is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"FIRST_NAME\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "455b2050-381b-4964-8752-4143755e6996",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column LAST_NAME is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"LAST_NAME\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "f56834d4-40cf-478c-a4ba-bec92cc59265",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column PAT_BIRTH_DATE is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"PAT_BIRTH_DATE\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "15868a63-eb31-47a5-9f55-0e71d000c03c",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column MEDICAID_CIN is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"MEDICAID_CIN\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "b9d0988e-afd8-4443-9df7-0dd02884df1a",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column ENCOUNTER_ID is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"ENCOUNTER_ID\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "847381c1-561e-4a4f-afa7-b2851202b04b",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column SURVEY is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"SURVEY\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "1b9a9bef-7f28-43e1-8956-454bc775cf77",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column SURVEY_ID is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"SURVEY_ID\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "23df3b39-347d-4091-a2ef-77c6ee3256f8",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column RECORDED_TIME is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"RECORDED_TIME\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "bb2504c7-0bb5-4664-bc49-1a233a0aa321",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column QUESTION is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"QUESTION\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "53171127-f04a-420a-9c19-9dc87d3dad33",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column MEAS_VALUE is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"MEAS_VALUE\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "42fee73a-c3f5-450e-af0b-84f3a945e3c9",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column QUESTION_CODE is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"QUESTION_CODE\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "db2f4386-3e01-4852-94da-bfcabe69edf9",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column QUESTION_CODE_SYSTEM_NAME is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"QUESTION_CODE_SYSTEM_NAME\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "623332c5-6c98-48e6-a314-fff385e13377",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column ANSWER_CODE is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"ANSWER_CODE\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "3cc08034-c98a-4bf4-a43d-715c19513897",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column ANSWER_CODE_SYSTEM_NAME is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"ANSWER_CODE_SYSTEM_NAME\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "0eb487b4-92a3-4aca-b2db-dd9925dac12b",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column SDOH_DOMAIN is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"SDOH_DOMAIN\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "37ad9a18-3b78-4efe-93ca-583262a46cfd",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column NEED_INDICATED is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"NEED_INDICATED\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "68eeaf59-3b60-4bf4-89e1-7ea93c100d82",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column VISIT_PART_2_FLAG is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"VISIT_PART_2_FLAG\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "37e84512-2d22-44b4-ab8c-140f347f606e",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column VISIT_OMH_FLAG is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"VISIT_OMH_FLAG\"",
        "elaboration": null
      },
      {
        "ingest_issue_tabular_id": "c7111633-b226-4b9c-b4e6-d7cfc60c527f",
        "session_id": "6aebd5b8-c1b6-4afb-b160-6328bd174c01",
        "issue_type": "Missing Column",
        "issue_message": "Required column VISIT_OPWDD_FLAG is missing in synthetic_fail.",
        "issue_row": null,
        "issue_column": null,
        "invalid_value": null,
        "remediation": "Ensure synthetic_fail contains the column \"VISIT_OPWDD_FLAG\"",
        "elaboration": null
      }
    ]
  },
  {
    "cell": "structuralSQL",
    "sql": "INSERT INTO ingest_session (ingest_session_id, ingest_src, ingest_table_name) \n                    VALUES ('9b5ab88a-e757-4520-b89f-b64c440235e1', '/home/snshah/workspaces/github.com/qe-collaborative-services/1115-hub/src/synthetic-content/ahc-hrsn-12-12-2023-valid.csv', 'ahc_hrsn_12_12_2023_valid');\n\nCREATE TABLE ahc_hrsn_12_12_2023_valid AS\n  SELECT *, row_number() OVER () as src_file_row_number, '9b5ab88a-e757-4520-b89f-b64c440235e1'\n    FROM read_csv_auto('/home/snshah/workspaces/github.com/qe-collaborative-services/1115-hub/src/synthetic-content/ahc-hrsn-12-12-2023-valid.csv', header=true);\n\nWITH required_column_names_in_src AS (\n    SELECT column_name\n      FROM (VALUES ('PAT_MRN_ID'), ('FACILITY'), ('FIRST_NAME'), ('LAST_NAME'), ('PAT_BIRTH_DATE'), ('MEDICAID_CIN'), ('ENCOUNTER_ID'), ('SURVEY'), ('SURVEY_ID'), ('RECORDED_TIME'), ('QUESTION'), ('MEAS_VALUE'), ('QUESTION_CODE'), ('QUESTION_CODE_SYSTEM_NAME'), ('ANSWER_CODE'), ('ANSWER_CODE_SYSTEM_NAME'), ('SDOH_DOMAIN'), ('NEED_INDICATED'), ('VISIT_PART_2_FLAG'), ('VISIT_OMH_FLAG'), ('VISIT_OPWDD_FLAG')) AS required(column_name)\n     WHERE required.column_name NOT IN (\n         SELECT upper(trim(column_name))\n           FROM information_schema.columns\n          WHERE table_name = 'ahc_hrsn_12_12_2023_valid')\n)\nINSERT INTO ingest_issue_tabular (ingest_issue_tabular_id, session_id, issue_type, issue_message, remediation)\n          SELECT uuid(),\n                 '9b5ab88a-e757-4520-b89f-b64c440235e1', \n                 'Missing Column',\n                 'Required column ' || column_name || ' is missing in ahc_hrsn_12_12_2023_valid.',\n                 'Ensure ahc_hrsn_12_12_2023_valid contains the column \"' || column_name || '\"'\n            FROM required_column_names_in_src;\n\n-- emit the errors for the given session (file) so it can be picked up\nSELECT * FROM ingest_issue_tabular WHERE session_id = '9b5ab88a-e757-4520-b89f-b64c440235e1';",
    "status": 0,
    "result": ""
  },
  {
    "cell": "contentSQL",
    "sql": "WITH numeric_value_in_all_rows AS (\n    SELECT 'SURVEY_ID' AS issue_column,\n           SURVEY_ID AS invalid_value,\n           src_file_row_number AS issue_row\n      FROM ahc_hrsn_12_12_2023_valid\n     WHERE SURVEY_ID IS NOT NULL\n       AND SURVEY_ID NOT SIMILAR TO '^[+-]?[0-9]+$'\n)\nINSERT INTO ingest_issue_tabular (ingest_issue_tabular_id, session_id, issue_type, issue_row, issue_column, invalid_value, issue_message, remediation)\n          SELECT uuid(),\n                 '9b5ab88a-e757-4520-b89f-b64c440235e1', \n                 'Data Type Mismatch',\n                 issue_row,\n                 issue_column,\n                 invalid_value,\n                 'Non-integer value \"' || invalid_value || '\" found in ' || issue_column,\n                 'Convert non-integer values to INTEGER'\n            FROM numeric_value_in_all_rows;",
    "status": 0
  },
  {
    "cell": "emitResources",
    "sql": "\n        INSTALL spatial; -- Only needed once per DuckDB connection\n        LOAD spatial; -- Only needed once per DuckDB connection\n        -- TODO: join with ingest_session table to give all the results in one sheet\n        COPY (SELECT * FROM ingest_issue_tabular) TO 'ingested/diagnostics.xlsx' WITH (FORMAT GDAL, DRIVER 'xlsx');",
    "status": 0
  },
  {
    "cell": "emitResources",
    "sql": "\n        ATTACH 'ingested/resource.sqlite.db' AS resource_db (TYPE SQLITE);\n\n        CREATE TABLE resource_db.ingest_session AS \n            SELECT * FROM ingest_session;\n\n        CREATE TABLE resource_db.ingest_issue_tabular AS \n            SELECT * FROM ingest_issue_tabular;\n\n        CREATE TABLE resource_db.ahc_hrsn_12_12_2023_valid AS SELECT * FROM ahc_hrsn_12_12_2023_valid;\n\n        DETACH DATABASE resource_db;",
    "status": 0
  }
]